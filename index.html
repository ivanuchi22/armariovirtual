<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Closet v16 - Laundry Flow</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --bg: #dfe6e9; --text: #2d3436; --success: #00b894; --danger: #d63031; --warning: #fdcb6e; --laundry: #e17055; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: var(--text); }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), #0984e3); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .auth-box { background: white; padding: 30px; border-radius: 15px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-auth { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* --- APP UI --- */
        #app-content { display: none; }

        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }

        /* WIDGET CLIMA */
        #weather-widget { background: linear-gradient(to right, #74b9ff, #0984e3); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }

        nav { display: flex; background: white; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        nav button { flex: 1; min-width: 60px; border: none; background: none; padding: 10px 2px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #b2bec3; transition: 0.3s; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; gap: 4px;}
        nav button.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8f9fa; }

        main { max-width: 900px; margin: 10px auto; padding: 0 15px; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        
        .panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* GENERAL INPUTS */
        label { display: block; font-size: 0.8rem; font-weight: bold; color: #636e72; margin: 10px 0 5px; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 6px; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.2s; box-shadow: 0 4px 6px rgba(108, 92, 231, 0.2); }

        /* UPLOAD */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .preview-box { background: #f1f2f6; height: 200px; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px dashed #b2bec3; overflow: hidden; }
        .preview-box img { width: 100%; height: 100%; object-fit: contain; }

        /* GALER√çA */
        .filter-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .chip { background: white; border: 1px solid #dfe6e9; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .card img { width: 100%; height: 160px; object-fit: cover; }
        .card-info { padding: 12px; }
        .price-badge { font-size: 0.8rem; font-weight: bold; color: var(--success); float: right; }
        .card-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .btn-icon { background: white; border-radius: 50%; width: 28px; height: 28px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        
        /* BOT√ìN DE LAVADO (NUEVO) */
        .btn-wash { background: var(--success); color: white; border: none; padding: 8px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 8px; font-weight: bold; transition: 0.2s; }
        .btn-wash:hover { background: #00b894; transform: scale(1.02); }

        /* OUTFITS */
        .outfit-result { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .outfit-piece { width: 30%; min-width: 120px; background: white; padding: 10px; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .outfit-piece img { width: 100%; height: 140px; object-fit: cover; border-radius: 6px; margin-bottom: 5px; }
        .btn-save-outfit { background: var(--success); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; display: none; animation: fadeIn 0.5s; }

        /* CALENDARIO & OOTD */
        .ootd-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .calendar-day { aspect-ratio: 1; border: 1px solid #eee; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8rem; background: white; position: relative; cursor: pointer; transition: 0.2s; }
        .calendar-day:hover { background: #f0f9ff; }
        .calendar-day.active { border-color: var(--primary); color: var(--primary); font-weight: bold; background: #eef2ff; border-width: 2px; }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; margin-top: 4px; }
        .btn-sim { background: linear-gradient(45deg, #fdcb6e, #e17055); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.8rem; margin-top: 10px; width: 100%; box-shadow: 0 3px 5px rgba(0,0,0,0.1); }
        .btn-sim:hover { transform: scale(1.02); }

        /* STATS & SHOP */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-num { font-size: 1.8rem; font-weight: bold; color: var(--primary); display: block; }
        .laundry-bar { height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .laundry-fill { height: 100%; background: var(--warning); width: 0%; transition: width 1s; }
        
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
        .shop-item { display: flex; align-items: center; gap: 15px; background: #f0fff4; border: 1px solid #b2bec3; padding: 15px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .shop-item:hover { border-color: var(--success); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,184,148,0.2); }
        .shop-img { width: 60px; height: 60px; background: #ddd; border-radius: 8px; object-fit: cover; }
        
        .vinted-card { background: #fff0f1; border-left: 5px solid var(--danger); padding: 20px; margin-top: 20px; display: flex; align-items: center; justify-content: space-between; gap: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(214, 48, 49, 0.1); }
        .vinted-btn { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .vinted-btn:hover { background: #c0392b; transform: scale(1.05); }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 25px; border-radius: 12px; width: 95%; max-width: 450px; animation: fadeIn 0.3s; max-height: 90vh; overflow-y: auto; }
        .ootd-gallery { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .ootd-gallery img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .ootd-preview-img { width: 100%; height: 250px; object-fit: cover; border-radius: 8px; margin-top: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2>üëó Smart Closet v16</h2>
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-pass" placeholder="Contrase√±a">
            <button class="btn-auth" id="btn-auth-action">Entrar / Registrarse</button>
            <p id="auth-error" style="color:white; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-content">
        <header>
            <div style="font-weight:bold;">‚òÅÔ∏è Life OS</div>
            <button class="btn-logout" id="btn-logout">Salir</button>
        </header>
        
        <div id="weather-widget"></div>

        <nav>
            <button onclick="nav('upload')" class="active" id="nav-upload">‚ûï<br>Subir</button>
            <button onclick="nav('gallery')" id="nav-gallery">üëó<br>Armario</button>
            <button onclick="nav('laundry')" id="nav-laundry">üß∫<br>Sucia</button>
            <button onclick="nav('outfit')" id="nav-outfit">‚ú®<br>Outfits</button>
            <button onclick="nav('agenda')" id="nav-agenda">üìÖ<br>Agenda</button>
            <button onclick="nav('stats')" id="nav-stats">üìä<br>Datos</button>
        </nav>

        <main>
            <div id="upload" class="section active">
                <div class="panel">
                    <div class="upload-grid">
                        <div>
                            <input type="file" id="inpFile" accept="image/*">
                            <div class="preview-box" id="previewBox"><span>üì∑ Foto</span></div>
                            <div class="loader" id="loader"></div>
                            <p id="ai-msg" style="text-align:center; color:var(--primary); font-size:0.8rem;"></p>
                        </div>
                        <div>
                            <h3>Nueva Prenda</h3>
                            <select id="catInput"><option value="top">Arriba</option><option value="bottom">Abajo</option><option value="shoes">Calzado</option><option value="coat">Abrigo</option></select>
                            <div style="display:flex; gap:10px;">
                                <select id="styleInput" style="flex:1"><option value="casual">Casual</option><option value="elegante">Elegante</option><option value="urbano">Urbano</option></select>
                                <select id="seasonInput" style="flex:1"><option value="verano">Verano</option><option value="invierno">Invierno</option></select>
                            </div>
                            <div style="display:flex; gap:5px; margin-top:10px;">
                                <input type="color" id="colorPicker" style="height:35px;">
                                <input type="text" id="colorHex" readonly>
                            </div>
                            <label>Precio (‚Ç¨)</label><input type="number" id="priceInput" placeholder="0.00" step="0.01">
                            <label>Descripci√≥n</label><input type="text" id="descInput" placeholder="Ej. Vaqueros azules...">
                            <button class="btn-main" id="btn-save">Guardar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gallery" class="section">
                <div class="filter-chips">
                    <div class="chip active" onclick="filterGallery('all', this)">Todo</div>
                    <div class="chip" onclick="filterGallery('top', this)">Tops</div>
                    <div class="chip" onclick="filterGallery('bottom', this)">Pantalones</div>
                    <div class="chip" onclick="filterGallery('shoes', this)">Zapatos</div>
                </div>
                <div id="galleryGrid" class="gallery-grid"></div>
                <p id="emptyMsg" style="text-align:center; display:none; color:#777">Vac√≠o</p>
            </div>

            <div id="laundry" class="section">
                <div class="panel">
                    <h2>üß∫ Ropa en proceso de lavado</h2>
                    <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">Pulsa el bot√≥n cuando la ropa est√© limpia y planchada.</p>
                    <div id="laundryGrid" class="gallery-grid"></div>
                    <p id="emptyLaundry" style="text-align:center; display:none; color:#777">¬°Genial! No tienes ropa sucia.</p>
                </div>
            </div>

            <div id="outfit" class="section">
                <div class="panel">
                    <h2>Generador de Estilo</h2>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <select id="fStyle"><option value="all">Todo Estilo</option><option value="casual">Casual</option><option value="elegante">Elegante</option></select>
                        <select id="fSeason"><option value="all">Toda Temporada</option><option value="verano">Verano</option><option value="invierno">Invierno</option></select>
                    </div>
                    <button class="btn-main" onclick="generateOutfit()">üé≤ Generar</button>
                    
                    <div id="outfitResult" class="outfit-result"></div>
                    
                    <button id="btn-save-outfit" class="btn-save-outfit" onclick="saveOutfitToCalendar()">üíæ Guardar en Calendario (Hoy)</button>

                    <div id="shopSection" class="shop-section" style="display:none;">
                        <h4>üõçÔ∏è Completa el look (Recomendado)</h4>
                        <div class="shop-grid">
                            <div class="shop-item" onclick="alert('Redirigiendo a Amazon...')"><img src="https://via.placeholder.com/60?text=Bolso" class="shop-img"><div><b>Bolso Cuero</b><br><span style="color:green; font-weight:bold;">29.99‚Ç¨</span></div></div>
                            <div class="shop-item" onclick="alert('Redirigiendo a Zara...')"><img src="https://via.placeholder.com/60?text=Cinto" class="shop-img"><div><b>Cintur√≥n</b><br><span style="color:green; font-weight:bold;">15.50‚Ç¨</span></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="agenda" class="section">
                <div class="panel">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>üìÖ Agenda</h3>
                        <button class="btn-sim" onclick="simulateNextDay()">‚è© Avanzar D√≠a</button>
                    </div>
                    <p style="font-size:0.8rem; color:#666;" id="ootd-status">Hoy es d√≠a 14.</p>
                    
                    <div class="ootd-grid" id="ootdGrid"></div>
                    
                    <div style="margin-top:20px;">
                        <div class="event-card" onclick="alert('üí° Recomendaci√≥n: Camisa blanca.')"><b>10:00 - Reuni√≥n</b><br><small>Oficina</small></div>
                        <div class="event-card" style="border-color: #fdcb6e;" onclick="alert('üí° Recomendaci√≥n: Ropa c√≥moda.')"><b>18:30 - Gym</b><br><small>Sport</small></div>
                    </div>
                </div>
            </div>

            <div id="stats" class="section">
                <div class="panel">
                    <h2>üìä M√©tricas</h2>
                    <div class="stats-grid">
                        <div class="stat-box"><span class="stat-num" id="totalItems">0</span><small>Prendas</small></div>
                        <div class="stat-box"><span class="stat-num" id="totalValue" style="color:var(--success)">0‚Ç¨</span><small>Valor Total</small></div>
                    </div>
                    <div style="margin-top:20px;">
                        <h4 style="margin-bottom:5px;">üß∫ Cesto de Ropa Sucia (Real)</h4>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem;"><span>Limpio</span><span id="laundry-percent-txt">Sucio (0%)</span></div>
                        <div class="laundry-bar"><div class="laundry-fill" id="laundry-fill-bar" style="width:0%;"></div></div>
                        <p style="font-size:0.8rem; color:#666; margin-top:5px;" id="laundry-count-txt">0 prendas necesitan lavado.</p>
                    </div>
                    <h4 style="margin-top:30px;">üí∞ Coste por Uso (Top Rentables)</h4>
                    <div id="cpw-list"></div>
                    <div class="vinted-card" id="vintedCard" style="display:none;">
                        <div><b style="font-size:1.1rem;">‚ö†Ô∏è Oportunidad de Venta</b><p style="margin:5px 0; font-size:0.9rem; color:#555;">No te pones esto hace 6 meses.</p></div>
                        <button class="vinted-btn" onclick="alert('Conectando API Vinted...')">Vender</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span style="float:right; cursor:pointer; font-size:1.5rem;" onclick="closeEditModal()">√ó</span>
            <h2>‚úèÔ∏è Editar Prenda</h2>
            <label>Categor√≠a</label>
            <select id="editCat"><option value="top">Top</option><option value="bottom">Abajo</option><option value="shoes">Calzado</option><option value="coat">Abrigo</option></select>
            <div style="display:flex; gap:10px;"><div style="flex:1"><label>Estilo</label><select id="editStyle"><option value="casual">Casual</option><option value="elegante">Elegante</option><option value="urbano">Urbano</option></select></div><div style="flex:1"><label>Temporada</label><select id="editSeason"><option value="verano">Verano</option><option value="invierno">Invierno</option></select></div></div>
            <label>Color</label><div style="display:flex; gap:5px;"><input type="color" id="editColorPicker" style="height:35px;"><input type="text" id="editColorHex" readonly></div>
            <label>Precio (‚Ç¨)</label><input type="number" id="editPrice" step="0.01">
            <label>Descripci√≥n</label><input type="text" id="editDesc">
            <button class="btn-main" onclick="saveEdit()">üíæ Guardar Cambios</button>
        </div>
    </div>

    <div id="ootdModal" class="modal">
        <div class="modal-content">
            <span style="float:right; cursor:pointer; font-size:1.5rem;" onclick="closeOotdModal()">√ó</span>
            <h2 id="ootdDateTitle">üìÖ Outfit del D√≠a</h2>
            <div id="ootdContent" style="text-align:center;"></div>
            <button class="btn-main" style="background:#555; margin-top:10px;" onclick="closeOotdModal()">Cerrar</button>
        </div>
    </div>

    <canvas id="hiddenCanvas" style="display:none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, query, where } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ========================================================
        // !!! CLAVES INSERTADAS CORRECTAMENTE !!!
        // ========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyC64wNZ-WDjm9PR6VrbDdLlXcofYw3iv44",
            authDomain: "armariodemogratis.firebaseapp.com",
            projectId: "armariodemogratis",
            storageBucket: "armariodemogratis.firebasestorage.app",
            messagingSenderId: "892808665541",
            appId: "1:892808665541:web:e5500dea81f5f59c6a93ac"
        };
        // ========================================================

        // INIT
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e){}
        
        let currentUser = null;
        let wardrobeData = []; 

        // AUTH
        document.getElementById('btn-auth-action').addEventListener('click', async () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            try {
                try { await signInWithEmailAndPassword(auth, e, p); } 
                catch(err) { await createUserWithEmailAndPassword(auth, e, p); }
            } catch(error) { document.getElementById('auth-error').innerText = error.message; }
        });

        if(auth) {
            document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
            onAuthStateChanged(auth, (user) => {
                if(user) {
                    currentUser = user;
                    document.getElementById('auth-screen').style.display='none';
                    document.getElementById('app-content').style.display='block';
                    loadData();
                    initWeather(); 
                    initCalendar(); 
                } else {
                    currentUser = null;
                    document.getElementById('auth-screen').style.display='flex';
                    document.getElementById('app-content').style.display='none';
                }
            });
        }

        // IA
        let model, currentBase64;
        (async ()=> { try { model = await mobilenet.load(); } catch(e){} })();

        document.getElementById('inpFile').addEventListener('change', function() {
            const f = this.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                currentBase64 = e.target.result;
                const img = document.createElement('img'); img.src = currentBase64;
                document.getElementById('previewBox').innerHTML=''; document.getElementById('previewBox').appendChild(img);
                img.onload = async () => {
                    document.getElementById('loader').style.display='block';
                    extractColor(img, 'colorPicker', 'colorHex');
                    if(model) {
                        const p = await model.classify(img);
                        document.getElementById('ai-msg').innerText = "IA: " + p[0].className.split(',')[0];
                        const t = p[0].className.toLowerCase();
                        const sel = document.getElementById('catInput');
                        if(t.match(/shirt|top|jersey/)) sel.value='top';
                        if(t.match(/pant|jean/)) sel.value='bottom';
                        if(t.match(/shoe|sneaker/)) sel.value='shoes';
                        if(t.match(/coat/)) sel.value='coat';
                    }
                    document.getElementById('loader').style.display='none';
                }
            }
            r.readAsDataURL(f);
        });

        function extractColor(img, pId, hId) {
            const c=document.getElementById('hiddenCanvas'); const ctx=c.getContext('2d');
            c.width=50;c.height=50; ctx.drawImage(img,0,0,50,50);
            const d=ctx.getImageData(0,0,50,50).data;
            let r=0,g=0,b=0,n=0;
            for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];n++}
            const hex = "#"+((1<<24)+(Math.floor(r/n)<<16)+(Math.floor(g/n)<<8)+Math.floor(b/n)).toString(16).slice(1);
            document.getElementById(pId).value=hex; document.getElementById(hId).value=hex;
        }

        // SAVE
        document.getElementById('btn-save').addEventListener('click', async () => {
            if(!currentBase64 || !currentUser) return alert("Faltan datos");
            const item = {
                uid: currentUser.uid, img: currentBase64,
                cat: document.getElementById('catInput').value,
                style: document.getElementById('styleInput').value,
                season: document.getElementById('seasonInput').value,
                color: document.getElementById('colorHex').value,
                desc: document.getElementById('descInput').value || "Prenda",
                price: document.getElementById('priceInput').value || 0,
                isDirty: false, // Por defecto limpia
                date: Date.now()
            };
            try { await addDoc(collection(db, "clothes"), item); alert("Guardado!"); loadData(); } catch(e) { alert(e.message); }
        });

        // LOAD
        async function loadData() {
            if(!currentUser) return;
            const q = query(collection(db, "clothes"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            wardrobeData = [];
            snap.forEach(doc => { let d=doc.data(); d.id=doc.id; wardrobeData.push(d); });
            renderGallery('all'); 
            renderLaundry(); 
            updateStats();
        }

        // --- NEW: LAUNDRY LOGIC ---
        window.toggleDirty = async function(id, status) {
            await updateDoc(doc(db, "clothes", id), { isDirty: status });
            loadData();
        }

        function renderLaundry() {
            const grid = document.getElementById('laundryGrid');
            grid.innerHTML = "";
            const dirtyItems = wardrobeData.filter(i => i.isDirty === true);
            
            if(dirtyItems.length === 0) { 
                document.getElementById('emptyLaundry').style.display='block'; 
            } else {
                document.getElementById('emptyLaundry').style.display='none';
            }

            dirtyItems.forEach(i => {
                const d = document.createElement('div'); d.className='card';
                d.innerHTML=`
                    <img src="${i.img}" style="filter: grayscale(100%); height: 140px;">
                    <div class="card-info">
                        <b>${i.desc}</b><br>
                        <span style="color:#e17055; font-size:0.8rem">Sucio</span>
                        <button class="btn-wash" onclick="toggleDirty('${i.id}', false)">‚úÖ Lavado Completado</button>
                    </div>`;
                grid.appendChild(d);
            });
        }

        // GALLERY
        window.filterGallery = function(cat, btn) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderGallery(cat);
        }

        function renderGallery(filter) {
            const grid = document.getElementById('galleryGrid'); grid.innerHTML = "";
            // Filtramos tambi√©n que NO est√© sucia
            let items = wardrobeData.filter(i => i.isDirty !== true);
            
            if(filter !== 'all') items = items.filter(i => i.cat === filter);

            if(!items.length) { document.getElementById('emptyMsg').style.display='block'; return; }
            document.getElementById('emptyMsg').style.display='none';
            
            items.forEach(i => {
                const d = document.createElement('div'); d.className='card';
                d.innerHTML=`
                    <div class="card-actions">
                        <button class="btn-icon" style="color:orange" title="A la ropa sucia" onclick="toggleDirty('${i.id}', true)">üß∫</button>
                        <button class="btn-icon" style="color:blue" onclick="openEdit('${i.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon" style="color:red" onclick="delItem('${i.id}')">üóëÔ∏è</button>
                    </div>
                    <img src="${i.img}">
                    <div class="card-info"><span class="price-badge">${i.price}‚Ç¨</span><b>${i.desc}</b><br><span class="badge">${i.cat}</span></div>`;
                grid.appendChild(d);
            });
        }

        window.delItem = async function(id) { if(confirm("¬øBorrar?")) { await deleteDoc(doc(db, "clothes", id)); loadData(); } }

        // EDIT
        let editId = null;
        window.openEdit = function(id) {
            const i = wardrobeData.find(x => x.id === id); if(!i) return;
            editId = id;
            document.getElementById('editCat').value = i.cat;
            document.getElementById('editStyle').value = i.style || 'casual';
            document.getElementById('editSeason').value = i.season || 'verano';
            document.getElementById('editDesc').value = i.desc;
            document.getElementById('editPrice').value = i.price || 0;
            document.getElementById('editColorHex').value = i.color || '#000000';
            document.getElementById('editColorPicker').value = i.color || '#000000';
            document.getElementById('editModal').style.display = 'flex';
        }
        document.getElementById('editColorPicker').addEventListener('change', function(){document.getElementById('editColorHex').value = this.value;});
        window.closeEditModal = function() { document.getElementById('editModal').style.display = 'none'; }
        window.saveEdit = async function() {
            if(!editId) return;
            await updateDoc(doc(db, "clothes", editId), {
                cat: document.getElementById('editCat').value,
                style: document.getElementById('editStyle').value,
                season: document.getElementById('editSeason').value,
                color: document.getElementById('editColorHex').value,
                desc: document.getElementById('editDesc').value,
                price: document.getElementById('editPrice').value
            });
            closeEditModal(); loadData();
        }

        // OUTFIT
        let currentGeneratedOutfit = null;

        window.generateOutfit = function() {
            const s = document.getElementById('fStyle').value;
            // Solo usamos ropa LIMPIA
            let pool = wardrobeData.filter(i => i.isDirty !== true);
            
            if(s !== 'all') pool = pool.filter(i=>i.style===s);
            
            const t = pool.filter(i=>i.cat==='top'||i.cat==='coat');
            const b = pool.filter(i=>i.cat==='bottom');
            const sh = pool.filter(i=>i.cat==='shoes');
            
            const res = document.getElementById('outfitResult');
            const shop = document.getElementById('shopSection');
            const saveBtn = document.getElementById('btn-save-outfit');

            if(!t.length || !b.length || !sh.length) { 
                res.innerHTML="Falta ropa limpia."; shop.style.display='none'; saveBtn.style.display='none'; return; 
            }
            
            const rT = t[Math.floor(Math.random()*t.length)];
            const rB = b[Math.floor(Math.random()*b.length)];
            const rS = sh[Math.floor(Math.random()*sh.length)];
            
            currentGeneratedOutfit = [rT, rB, rS];

            res.innerHTML = `<div class="outfit-piece"><img src="${rT.img}"><small>${rT.desc}</small></div>
                             <div class="outfit-piece"><img src="${rB.img}"><small>${rB.desc}</small></div>
                             <div class="outfit-piece"><img src="${rS.img}"><small>${rS.desc}</small></div>`;
            shop.style.display='block';
            saveBtn.style.display='block';
        }

        // --- SIMULADOR DE D√çAS ---
        let currentSimDay = 14;
        let recordedDays = [2, 4, 8, 12]; 
        let ootdHistory = {}; 

        window.saveOutfitToCalendar = function() {
            if(!currentGeneratedOutfit) return;
            ootdHistory[currentSimDay] = currentGeneratedOutfit;
            if(!recordedDays.includes(currentSimDay)) recordedDays.push(currentSimDay);
            alert(`¬°Outfit guardado para el d√≠a ${currentSimDay}!`);
            initCalendar();
        }

        window.simulateNextDay = function() {
            currentSimDay++;
            if(currentSimDay > 28) currentSimDay = 1; 
            document.getElementById('ootd-status').innerText = `Hoy es d√≠a ${currentSimDay}.`;
            initCalendar(); 
        }

        function initCalendar() {
            const grid = document.getElementById('ootdGrid');
            grid.innerHTML = "";
            const days = ['L','M','X','J','V','S','D'];
            days.forEach(d => grid.innerHTML += `<div class="calendar-day" style="background:transparent;border:none;font-weight:bold;">${d}</div>`);

            for(let i=1; i<=28; i++) {
                const hasLook = recordedDays.includes(i);
                let dot = hasLook ? `<div class="dot"></div>` : '';
                let active = i === currentSimDay ? 'active' : '';
                let html = `<div class="calendar-day ${active}" onclick="clickDay(${i}, ${hasLook})">${i} ${dot}</div>`;
                grid.innerHTML += html;
            }
        }

        window.clickDay = function(day, hasLook) {
            if(hasLook) {
                document.getElementById('ootdDateTitle').innerText = `üìÖ Outfit del D√≠a ${day}`;
                const content = document.getElementById('ootdContent');
                content.innerHTML = "";

                if(ootdHistory[day]) {
                    const items = ootdHistory[day];
                    content.innerHTML = `<div class="ootd-gallery"><img src="${items[0].img}"><img src="${items[1].img}"><img src="${items[2].img}"></div><p style="margin-top:10px"><b>Look Guardado</b></p>`;
                } else if (wardrobeData.length > 0) {
                    const r = wardrobeData[Math.floor(Math.random()*wardrobeData.length)];
                    content.innerHTML = `<img src="${r.img}" class="ootd-preview-img"><p>Prenda del historial.</p>`;
                } else {
                    content.innerHTML = "<p>No hay ropa.</p>";
                }
                document.getElementById('ootdModal').style.display = 'flex';
            } else if (day === currentSimDay) {
                alert("Ve a Outfits para guardar tu look.");
            }
        }

        window.closeOotdModal = function() { document.getElementById('ootdModal').style.display='none'; }

        // STATS & WEATHER
        function initWeather() {
            const w = [ { i: "‚òÄÔ∏è", t: "28¬∞C", d: "Soleado", tip: "Usa gafas" }, { i: "üåßÔ∏è", t: "14¬∞C", d: "Lluvia", tip: "Lleva paraguas" } ];
            const rand = w[Math.floor(Math.random()*w.length)];
            document.getElementById('weather-widget').innerHTML = `<div style="display:flex; gap:10px; align-items:center;"><span style="font-size:1.5rem">${rand.i}</span><div><b>Madrid</b><br>${rand.d} ¬∑ ${rand.t}</div></div><div style="text-align:right"><small>Tip IA:</small><br><b>${rand.tip}</b></div>`;
        }

        function updateStats() {
            document.getElementById('totalItems').innerText = wardrobeData.length;
            let totalVal = 0;
            wardrobeData.forEach(i => totalVal += parseFloat(i.price || 0));
            document.getElementById('totalValue').innerText = totalVal.toFixed(2) + '‚Ç¨';
            
            // STATS REALES DE LAVANDER√çA
            const total = wardrobeData.length;
            const dirty = wardrobeData.filter(i => i.isDirty === true).length;
            const percent = total > 0 ? Math.round((dirty / total) * 100) : 0;
            
            document.getElementById('laundry-count-txt').innerText = `${dirty} prendas necesitan lavado.`;
            document.getElementById('laundry-percent-txt').innerText = `Sucio (${percent}%)`;
            document.getElementById('laundry-fill-bar').style.width = `${percent}%`;

            if(wardrobeData.length > 0) {
                if(wardrobeData.length >= 3) document.getElementById('vintedCard').style.display = 'flex';
                const cpwList = document.getElementById('cpw-list');
                cpwList.innerHTML = "";
                wardrobeData.slice(0, 3).forEach(i => {
                    const price = parseFloat(i.price) || 20; 
                    const uses = Math.floor(Math.random() * 20) + 1;
                    const cpw = (price / uses).toFixed(2);
                    cpwList.innerHTML += `<div class="cpw-item"><div style="display:flex; align-items:center; gap:10px;"><img src="${i.img}" style="width:40px; height:40px; border-radius:4px; object-fit:cover;"><div><b>${i.desc}</b><br><small>${uses} usos</small></div></div><div style="text-align:right;"><b>${cpw}‚Ç¨</b><br><small>/uso</small></div></div>`;
                });
            }
        }

        window.nav = function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('nav-'+id).classList.add('active');
        }
    </script>
</body>
</html>
