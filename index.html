<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wears</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%233b82f6%22/><path d=%22M20 35 L35 70 L50 40 L65 70 L80 35%22 fill=%22none%22 stroke=%22white%22 stroke-width=%228%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/><circle cx=%2250%22 cy=%2220%22 r=%226%22 fill=%22%23ef4444%22/></svg>">

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

    <style>
        :root { 
            /* COLORES BASADOS EN TU LOGO */
            --brand-blue: #3b82f6; 
            --brand-red: #ef4444;
            
            --primary: #3b82f6; /* Azul de tu marca */
            --secondary: #60a5fa; 
            --bg: #f3f4f6; 
            --text: #1f2937; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --laundry: #f97316;
            
            --card-bg: white; 
            --panel-bg: white; 
            --input-border: #e5e7eb;
        }
        
        /* MODO OSCURO */
        body.dark-mode {
            --bg: #111827; 
            --text: #f9fafb; 
            --card-bg: #1f2937; 
            --panel-bg: #1f2937; 
            --input-border: #374151; 
            --primary: #60a5fa;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: var(--text); transition: 0.3s; }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--brand-blue); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-auth { width: 100%; padding: 12px; background: var(--brand-blue); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        /* Logo en Login */
        .login-logo { width: 80px; height: 80px; margin-bottom: 20px; }

        /* --- APP UI --- */
        #app-content { display: none; }

        header { background: white; color: var(--text); padding: 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s; }
        /* Ajuste para modo oscuro en header */
        body.dark-mode header { background: #1f2937; }
        
        .btn-logout { background: #fee2e2; border: none; color: #ef4444; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; margin-left: 5px; font-weight: bold; }
        body.dark-mode .btn-logout { background: #7f1d1d; color: #fca5a5; }
        
        .btn-theme { background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px; }

        /* WIDGET CLIMA */
        #weather-widget { background: linear-gradient(to right, var(--brand-blue), #2563eb); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }

        nav { display: flex; background: var(--panel-bg); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow-x: auto; transition: 0.3s; }
        nav button { flex: 1; min-width: 65px; border: none; background: none; padding: 12px 5px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #9ca3af; transition: 0.3s; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 5px;}
        nav button.active { color: var(--brand-blue); border-bottom-color: var(--brand-blue); background: rgba(59, 130, 246, 0.05); }

        main { max-width: 900px; margin: 15px auto; padding: 0 15px; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        
        .panel { background: var(--panel-bg); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.3s; }
        
        /* GENERAL INPUTS */
        label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text); opacity: 0.8; margin: 12px 0 6px; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid var(--input-border); border-radius: 8px; box-sizing: border-box; background: var(--card-bg); color: var(--text); font-size: 1rem; }
        .btn-main { background: var(--brand-blue); color: white; width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.2s; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4); }

        /* UPLOAD */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width:600px){ .upload-grid { grid-template-columns: 1fr; } }
        .preview-box { background: rgba(0,0,0,0.03); height: 250px; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px dashed #cbd5e1; overflow: hidden; margin-bottom: 10px; }
        .preview-box img { width: 100%; height: 100%; object-fit: contain; }

        /* GALER√çA */
        .filter-chips { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .chip { background: var(--card-bg); border: 1px solid var(--input-border); padding: 8px 16px; border-radius: 25px; font-size: 0.9rem; cursor: pointer; white-space: nowrap; color: var(--text); transition: 0.2s; }
        .chip.active { background: var(--brand-blue); color: white; border-color: var(--brand-blue); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; transition: 0.3s; border: 1px solid var(--input-border); }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card-info { padding: 12px; }
        .price-badge { font-size: 0.85rem; font-weight: bold; color: var(--success); float: right; background: #ecfdf5; padding: 2px 6px; border-radius: 4px; }
        body.dark-mode .price-badge { background: rgba(16, 185, 129, 0.2); }
        .card-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; }
        .btn-icon { background: white; border-radius: 50%; width: 32px; height: 32px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: 0.2s; }
        .btn-icon:hover { transform: scale(1.1); }
        
        .btn-wash { background: var(--success); color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin-top: 10px; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* OUTFITS */
        .outfit-result { display: flex; justify-content: center; gap: 10px; margin-top: 25px; flex-wrap: wrap; }
        .outfit-piece { width: 30%; min-width: 110px; background: var(--card-bg); padding: 10px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid var(--input-border); }
        .outfit-piece img { width: 100%; height: 130px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; }
        .btn-save-outfit { background: var(--success); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; display: none; animation: fadeIn 0.5s; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }

        /* CALENDARIO */
        .ootd-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px; }
        .calendar-day { aspect-ratio: 1; border: 1px solid var(--input-border); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; background: var(--card-bg); position: relative; cursor: pointer; transition: 0.2s; }
        .calendar-day:hover { border-color: var(--brand-blue); }
        .calendar-day.active { background: var(--brand-blue); color: white; border-color: var(--brand-blue); font-weight: bold; }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; margin-top: 4px; }
        .calendar-day.active .dot { background: white; }
        .btn-sim { background: white; border: 1px solid var(--input-border); color: var(--text); padding: 6px 12px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* STATS & SHOP */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--input-border); }
        .stat-num { font-size: 2rem; font-weight: 800; color: var(--brand-blue); display: block; margin-bottom: 5px; }
        
        /* LAUNDRY BAR */
        .laundry-container { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--input-border); margin-top: 20px; }
        .laundry-bar { height: 12px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .laundry-fill { height: 100%; background: var(--laundry); width: 0%; transition: width 1s; border-radius: 10px; }
        
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
        .shop-item { display: flex; align-items: center; gap: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        body.dark-mode .shop-item { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2); }
        .shop-img { width: 50px; height: 50px; background: #ddd; border-radius: 8px; object-fit: cover; }
        
        .vinted-card { background: #fef2f2; border: 1px solid #fecaca; padding: 20px; margin-top: 20px; display: flex; align-items: center; justify-content: space-between; gap: 15px; border-radius: 12px; }
        body.dark-mode .vinted-card { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); }
        .vinted-btn { background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* VIAJES */
        .trip-item { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--input-border); padding: 12px 0; }
        .trip-check { width: 20px; height: 20px; accent-color: var(--brand-blue); cursor: pointer; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--card-bg); color: var(--text); padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; animation: scaleUp 0.3s; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .ootd-gallery { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .ootd-gallery img { width: 90px; height: 90px; object-fit: cover; border-radius: 10px; border: 2px solid var(--input-border); }
        .ootd-preview-img { width: 100%; height: 250px; object-fit: cover; border-radius: 12px; margin-top: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--brand-blue); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="auth-screen">
        <svg class="login-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <rect width="100" height="100" rx="22" fill="white"/>
            <path d="M20 35 L35 70 L50 40 L65 70 L80 35" fill="none" stroke="#3b82f6" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="50" cy="20" r="6" fill="#ef4444"/>
        </svg>

        <div class="auth-box">
            <h2 style="margin-top:0;">Bienvenido a Wears</h2>
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-pass" placeholder="Contrase√±a">
            <button class="btn-auth" id="btn-auth-action">Entrar / Registrarse</button>
            <p id="auth-error" style="color:#d63031; margin-top:10px; font-weight:bold; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="app-content">
        <header>
            <div style="display:flex; align-items:center; gap:12px;">
                <svg width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100" height="100" rx="20" fill="#3b82f6"/>
                    <path d="M20 35 L35 70 L50 40 L65 70 L80 35" fill="none" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="50" cy="20" r="6" fill="#ef4444"/>
                    <text x="50" y="92" font-family="Arial, sans-serif" font-size="24" fill="white" font-weight="bold" text-anchor="middle">wears</text>
                </svg>
                <span style="font-size:1.4rem; font-weight:bold; color:var(--brand-blue);">wears</span>
                <button class="btn-theme" onclick="toggleTheme()" title="Modo Oscuro">üåô</button>
            </div>
            <div>
                <button class="btn-logout" id="btn-logout">Salir</button>
            </div>
        </header>
        
        <div id="weather-widget"></div>

        <nav>
            <button onclick="nav('upload')" class="active" id="nav-upload">‚ûï<br>Subir</button>
            <button onclick="nav('gallery')" id="nav-gallery">üëó<br>Armario</button>
            <button onclick="nav('laundry')" id="nav-laundry">üß∫<br>Sucia</button>
            <button onclick="nav('outfit')" id="nav-outfit">‚ú®<br>Outfits</button>
            <button onclick="nav('travel')" id="nav-travel">üß≥<br>Viajes</button> 
            <button onclick="nav('agenda')" id="nav-agenda">üìÖ<br>Agenda</button>
            <button onclick="nav('stats')" id="nav-stats">üìä<br>Datos</button>
        </nav>

        <main>
            <div id="upload" class="section active">
                <div class="panel">
                    <div class="upload-grid">
                        <div>
                            <input type="file" id="inpFile" accept="image/*">
                            <div class="preview-box" id="previewBox"><span>üì∑ Toca para foto</span></div>
                            <div class="loader" id="loader"></div>
                            <p id="ai-msg" style="text-align:center; color:var(--primary); font-size:0.9rem; font-weight:600;"></p>
                        </div>
                        <div>
                            <h3>Nueva Prenda</h3>
                            <label>Categor√≠a (IA)</label>
                            <select id="catInput"><option value="top">Arriba</option><option value="bottom">Abajo</option><option value="shoes">Calzado</option><option value="coat">Abrigo</option></select>
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1"><label>Estilo</label><select id="styleInput"><option value="casual">Casual</option><option value="elegante">Elegante</option><option value="urbano">Urbano</option></select></div>
                                <div style="flex:1"><label>Temporada</label><select id="seasonInput"><option value="verano">Verano</option><option value="invierno">Invierno</option></select></div>
                            </div>
                            <label>Color Principal</label>
                            <div style="display:flex; gap:5px;">
                                <input type="color" id="colorPicker" style="height:45px; cursor:pointer;">
                                <input type="text" id="colorHex" readonly>
                            </div>
                            <label>Precio (‚Ç¨)</label><input type="number" id="priceInput" placeholder="0.00" step="0.01">
                            <label>Descripci√≥n</label><input type="text" id="descInput" placeholder="Ej. Vaqueros azules...">
                            <button class="btn-main" id="btn-save">Guardar en Armario</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gallery" class="section">
                <div class="filter-chips">
                    <div class="chip active" onclick="filterGallery('all', this)">Todo</div>
                    <div class="chip" onclick="filterGallery('top', this)">Tops</div>
                    <div class="chip" onclick="filterGallery('bottom', this)">Pantalones</div>
                    <div class="chip" onclick="filterGallery('shoes', this)">Zapatos</div>
                    <div class="chip" onclick="filterGallery('coat', this)">Abrigos</div>
                </div>
                <div id="galleryGrid" class="gallery-grid"></div>
                <div id="emptyMsg" style="text-align:center; display:none; padding:40px; color:#888;">
                    <div style="font-size:3rem; margin-bottom:10px;">üì≠</div>
                    Tu armario est√° vac√≠o. ¬°Sube algo!
                </div>
            </div>

            <div id="laundry" class="section">
                <div class="panel">
                    <h2>üß∫ Ropa Sucia</h2>
                    <p style="font-size:0.9rem; opacity:0.7; margin-bottom:20px;">Gestiona tu ciclo de lavado aqu√≠.</p>
                    <div id="laundryGrid" class="gallery-grid"></div>
                    <p id="emptyLaundry" style="text-align:center; display:none; opacity:0.7; padding:20px;">‚ú® Todo limpio.</p>
                </div>
            </div>

            <div id="outfit" class="section">
                <div class="panel">
                    <h2>Generador de Estilo</h2>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <select id="fStyle"><option value="all">Todo Estilo</option><option value="casual">Casual</option><option value="elegante">Elegante</option></select>
                        <select id="fSeason"><option value="all">Toda Temporada</option><option value="verano">Verano</option><option value="invierno">Invierno</option></select>
                    </div>
                    <button class="btn-main" onclick="generateOutfit()">üé≤ Generar Outfit IA</button>
                    <div id="outfitResult" class="outfit-result"></div>
                    <button id="btn-save-outfit" class="btn-save-outfit" onclick="saveOutfitToCalendar()">üíæ Guardar en Calendario (Hoy)</button>
                    <div id="shopSection" class="shop-section" style="display:none; margin-top:30px; border-top:1px dashed #ddd; padding-top:20px;">
                        <h4>üõçÔ∏è Completa el look</h4>
                        <div class="shop-grid">
                            <div class="shop-item" onclick="alert('Redirigiendo a Amazon...')"><img src="https://via.placeholder.com/60?text=Bolso" class="shop-img"><div><b>Bolso Cuero</b><br><span style="color:var(--success); font-weight:bold;">29.99‚Ç¨</span></div></div>
                            <div class="shop-item" onclick="alert('Redirigiendo a Zara...')"><img src="https://via.placeholder.com/60?text=Cinto" class="shop-img"><div><b>Cintur√≥n</b><br><span style="color:var(--success); font-weight:bold;">15.50‚Ç¨</span></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="travel" class="section">
                <div class="panel">
                    <h2>üß≥ Planificador de Viajes</h2>
                    <p style="font-size:0.9rem; opacity:0.7;">La IA seleccionar√° ropa limpia de tu armario.</p>
                    <label>Destino</label><input type="text" id="tripDest" placeholder="Ej. Par√≠s">
                    <label>Duraci√≥n (D√≠as)</label><input type="number" id="tripDays" value="3" min="1" max="14">
                    <button class="btn-main" onclick="generateTrip()">Generar Maleta</button>
                    <div id="tripResult" style="margin-top:20px; display:none; background:rgba(0,0,0,0.02); padding:15px; border-radius:10px;">
                        <h3 id="tripTitle" style="color:var(--primary)"></h3>
                        <div id="tripList"></div>
                    </div>
                </div>
            </div>

            <div id="agenda" class="section">
                <div class="panel">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>üìÖ Agenda</h3>
                        <button class="btn-sim" onclick="simulateNextDay()">‚è© Avanzar D√≠a</button>
                    </div>
                    <p style="font-size:0.8rem; opacity:0.7;" id="ootd-status">Hoy es d√≠a 14.</p>
                    <div class="ootd-grid" id="ootdGrid"></div>
                    <div style="margin-top:30px;">
                        <h4>Eventos Pr√≥ximos</h4>
                        <div class="trip-item" onclick="alert('üí° Recomendaci√≥n: Camisa blanca.')"><b>10:00 - Reuni√≥n</b><span style="font-size:0.8rem; background:#e0e7ff; color:#3730a3; padding:2px 6px; border-radius:4px; margin-left:auto;">Oficina</span></div>
                        <div class="trip-item" onclick="alert('üí° Recomendaci√≥n: Ropa c√≥moda.')"><b>18:30 - Gym</b><span style="font-size:0.8rem; background:#fef3c7; color:#92400e; padding:2px 6px; border-radius:4px; margin-left:auto;">Sport</span></div>
                    </div>
                </div>
            </div>

            <div id="stats" class="section">
                <div class="panel">
                    <h2>üìä M√©tricas</h2>
                    <div class="stats-grid">
                        <div class="stat-box"><span class="stat-num" id="totalItems">0</span><small>Prendas</small></div>
                        <div class="stat-box"><span class="stat-num" id="totalValue" style="color:var(--success)">0‚Ç¨</span><small>Valor Total</small></div>
                    </div>
                    <div class="laundry-container">
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:bold;"><span>Limpio</span><span id="laundry-percent-txt" style="color:var(--laundry)">Sucio (0%)</span></div>
                        <div class="laundry-bar"><div class="laundry-fill" id="laundry-fill-bar" style="width:0%;"></div></div>
                        <p style="font-size:0.8rem; opacity:0.7; margin-top:8px;" id="laundry-count-txt">0 prendas necesitan lavado.</p>
                    </div>
                    <h4 style="margin-top:30px;">üí∞ Coste por Uso (Top Rentables)</h4>
                    <div id="cpw-list"></div>
                    <div class="vinted-card" id="vintedCard" style="display:none;">
                        <div><b style="font-size:1.1rem; color:#b91c1c;">‚ö†Ô∏è Oportunidad de Venta</b><p style="margin:5px 0; font-size:0.9rem; opacity:0.8;">No te pones esto hace 6 meses.</p></div>
                        <button class="vinted-btn" onclick="alert('Conectando API Vinted...')">Vender</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>‚úèÔ∏è Editar Prenda</h2>
                <span style="font-size:1.5rem; cursor:pointer;" onclick="closeEditModal()">√ó</span>
            </div>
            <label>Categor√≠a</label>
            <select id="editCat"><option value="top">Top</option><option value="bottom">Abajo</option><option value="shoes">Calzado</option><option value="coat">Abrigo</option></select>
            <div style="display:flex; gap:10px;"><div style="flex:1"><label>Estilo</label><select id="editStyle"><option value="casual">Casual</option><option value="elegante">Elegante</option><option value="urbano">Urbano</option></select></div><div style="flex:1"><label>Temporada</label><select id="editSeason"><option value="verano">Verano</option><option value="invierno">Invierno</option></select></div></div>
            <label>Color</label><div style="display:flex; gap:5px;"><input type="color" id="editColorPicker" style="height:45px; cursor:pointer;"><input type="text" id="editColorHex" readonly></div>
            <label>Precio (‚Ç¨)</label><input type="number" id="editPrice" step="0.01">
            <label>Descripci√≥n</label><input type="text" id="editDesc">
            <button class="btn-main" onclick="saveEdit()">üíæ Guardar Cambios</button>
        </div>
    </div>

    <div id="ootdModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="ootdDateTitle" style="margin:0">üìÖ Outfit</h2>
                <span style="font-size:1.5rem; cursor:pointer;" onclick="closeOotdModal()">√ó</span>
            </div>
            <div id="ootdContent" style="text-align:center; padding-top:10px;"></div>
            <button class="btn-main" style="background:#4b5563; margin-top:20px;" onclick="closeOotdModal()">Cerrar</button>
        </div>
    </div>

    <canvas id="hiddenCanvas" style="display:none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, query, where } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === CONFIGURACI√ìN ===
        const firebaseConfig = {
            apiKey: "AIzaSyC64wNZ-WDjm9PR6VrbDdLlXcofYw3iv44",
            authDomain: "armariodemogratis.firebaseapp.com",
            projectId: "armariodemogratis",
            storageBucket: "armariodemogratis.firebasestorage.app",
            messagingSenderId: "892808665541",
            appId: "1:892808665541:web:e5500dea81f5f59c6a93ac"
        };

        // INIT
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e){}
        
        let currentUser = null;
        let wardrobeData = []; 

        // AUTH
        document.getElementById('btn-auth-action').addEventListener('click', async () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            if(!e || !p) return document.getElementById('auth-error').innerText = "Rellena los campos";
            try {
                try { await signInWithEmailAndPassword(auth, e, p); } 
                catch(err) { await createUserWithEmailAndPassword(auth, e, p); }
            } catch(error) { document.getElementById('auth-error').innerText = error.message; }
        });

        if(auth) {
            document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
            onAuthStateChanged(auth, (user) => {
                if(user) {
                    currentUser = user;
                    document.getElementById('auth-screen').style.display='none';
                    document.getElementById('app-content').style.display='block';
                    loadData();
                    initWeather(); 
                    initCalendar(); 
                } else {
                    currentUser = null;
                    document.getElementById('auth-screen').style.display='flex';
                    document.getElementById('app-content').style.display='none';
                }
            });
        }

        // IA
        let model, currentBase64;
        (async ()=> { try { model = await mobilenet.load(); } catch(e){} })();

        document.getElementById('inpFile').addEventListener('change', function() {
            const f = this.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                currentBase64 = e.target.result;
                const img = document.createElement('img'); img.src = currentBase64;
                document.getElementById('previewBox').innerHTML=''; document.getElementById('previewBox').appendChild(img);
                img.onload = async () => {
                    document.getElementById('loader').style.display='block';
                    extractColor(img, 'colorPicker', 'colorHex');
                    if(model) {
                        const p = await model.classify(img);
                        document.getElementById('ai-msg').innerText = "IA Detecta: " + p[0].className.split(',')[0];
                        const t = p[0].className.toLowerCase();
                        const sel = document.getElementById('catInput');
                        if(t.match(/shirt|top|jersey/)) sel.value='top';
                        if(t.match(/pant|jean/)) sel.value='bottom';
                        if(t.match(/shoe|sneaker/)) sel.value='shoes';
                        if(t.match(/coat/)) sel.value='coat';
                    }
                    document.getElementById('loader').style.display='none';
                }
            }
            r.readAsDataURL(f);
        });

        function extractColor(img, pId, hId) {
            const c=document.getElementById('hiddenCanvas'); const ctx=c.getContext('2d');
            c.width=50;c.height=50; ctx.drawImage(img,0,0,50,50);
            const d=ctx.getImageData(0,0,50,50).data;
            let r=0,g=0,b=0,n=0;
            for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];n++}
            const hex = "#"+((1<<24)+(Math.floor(r/n)<<16)+(Math.floor(g/n)<<8)+Math.floor(b/n)).toString(16).slice(1);
            document.getElementById(pId).value=hex; document.getElementById(hId).value=hex;
        }

        // SAVE
        document.getElementById('btn-save').addEventListener('click', async () => {
            if(!currentBase64 || !currentUser) return alert("Falta foto");
            const item = {
                uid: currentUser.uid, img: currentBase64,
                cat: document.getElementById('catInput').value,
                style: document.getElementById('styleInput').value,
                season: document.getElementById('seasonInput').value,
                color: document.getElementById('colorHex').value,
                desc: document.getElementById('descInput').value || "Prenda",
                price: document.getElementById('priceInput').value || 0,
                isDirty: false,
                date: Date.now()
            };
            try { await addDoc(collection(db, "clothes"), item); alert("Guardado!"); loadData(); } catch(e) { alert(e.message); }
        });

        // LOAD
        async function loadData() {
            if(!currentUser) return;
            const q = query(collection(db, "clothes"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            wardrobeData = [];
            snap.forEach(doc => { let d=doc.data(); d.id=doc.id; wardrobeData.push(d); });
            renderGallery('all'); 
            renderLaundry(); 
            updateStats();
        }

        // LAUNDRY
        window.toggleDirty = async function(id, status) {
            await updateDoc(doc(db, "clothes", id), { isDirty: status });
            loadData();
        }

        function renderLaundry() {
            const grid = document.getElementById('laundryGrid'); grid.innerHTML = "";
            const dirtyItems = wardrobeData.filter(i => i.isDirty === true);
            document.getElementById('emptyLaundry').style.display = dirtyItems.length === 0 ? 'block' : 'none';
            dirtyItems.forEach(i => {
                const d = document.createElement('div'); d.className='card';
                d.innerHTML=`<img src="${i.img}" style="filter: grayscale(100%); height: 140px;"><div class="card-info"><b>${i.desc}</b><br><span style="color:#e17055; font-size:0.8rem">En cesto</span><button class="btn-wash" onclick="toggleDirty('${i.id}', false)">‚úÖ Lavado Listo</button></div>`;
                grid.appendChild(d);
            });
        }

        // GALLERY
        window.filterGallery = function(cat, btn) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderGallery(cat);
        }

        function renderGallery(filter) {
            const grid = document.getElementById('galleryGrid'); grid.innerHTML = "";
            let items = wardrobeData.filter(i => i.isDirty !== true);
            if(filter !== 'all') items = items.filter(i => i.cat === filter);
            document.getElementById('emptyMsg').style.display = items.length === 0 ? 'block' : 'none';
            items.forEach(i => {
                const d = document.createElement('div'); d.className='card';
                d.innerHTML=`
                    <div class="card-actions">
                        <button class="btn-icon" style="color:orange" title="A la ropa sucia" onclick="toggleDirty('${i.id}', true)">üß∫</button>
                        <button class="btn-icon" style="color:#3b82f6" onclick="openEdit('${i.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon" style="color:#ef4444" onclick="delItem('${i.id}')">üóëÔ∏è</button>
                    </div>
                    <img src="${i.img}">
                    <div class="card-info"><span class="price-badge">${i.price}‚Ç¨</span><b>${i.desc}</b><br><span class="badge" style="text-transform:capitalize">${i.cat}</span></div>`;
                grid.appendChild(d);
            });
        }

        window.delItem = async function(id) { if(confirm("¬øBorrar?")) { await deleteDoc(doc(db, "clothes", id)); loadData(); } }

        // EDIT
        let editId = null;
        window.openEdit = function(id) {
            const i = wardrobeData.find(x => x.id === id); if(!i) return;
            editId = id;
            document.getElementById('editCat').value = i.cat;
            document.getElementById('editStyle').value = i.style || 'casual';
            document.getElementById('editSeason').value = i.season || 'verano';
            document.getElementById('editDesc').value = i.desc;
            document.getElementById('editPrice').value = i.price || 0;
            document.getElementById('editColorHex').value = i.color || '#000000';
            document.getElementById('editColorPicker').value = i.color || '#000000';
            document.getElementById('editModal').style.display = 'flex';
        }
        document.getElementById('editColorPicker').addEventListener('change', function(){document.getElementById('editColorHex').value = this.value;});
        window.closeEditModal = function() { document.getElementById('editModal').style.display = 'none'; }
        window.saveEdit = async function() {
            if(!editId) return;
            await updateDoc(doc(db, "clothes", editId), {
                cat: document.getElementById('editCat').value,
                style: document.getElementById('editStyle').value,
                season: document.getElementById('editSeason').value,
                color: document.getElementById('editColorHex').value,
                desc: document.getElementById('editDesc').value,
                price: document.getElementById('editPrice').value
            });
            closeEditModal(); loadData();
        }

        // OUTFIT
        let currentGeneratedOutfit = null;
        window.generateOutfit = function() {
            const s = document.getElementById('fStyle').value;
            let pool = wardrobeData.filter(i => i.isDirty !== true);
            if(s !== 'all') pool = pool.filter(i=>i.style===s);
            const t = pool.filter(i=>i.cat==='top'||i.cat==='coat');
            const b = pool.filter(i=>i.cat==='bottom');
            const sh = pool.filter(i=>i.cat==='shoes');
            const res = document.getElementById('outfitResult');
            const shop = document.getElementById('shopSection');
            const saveBtn = document.getElementById('btn-save-outfit');
            if(!t.length || !b.length || !sh.length) { 
                res.innerHTML="<p style='color:red'>Falta ropa limpia para este estilo.</p>"; shop.style.display='none'; saveBtn.style.display='none'; return; 
            }
            const rT = t[Math.floor(Math.random()*t.length)];
            const rB = b[Math.floor(Math.random()*b.length)];
            const rS = sh[Math.floor(Math.random()*sh.length)];
            currentGeneratedOutfit = [rT, rB, rS];
            res.innerHTML = `<div class="outfit-piece"><img src="${rT.img}"><small>${rT.desc}</small></div>
                             <div class="outfit-piece"><img src="${rB.img}"><small>${rB.desc}</small></div>
                             <div class="outfit-piece"><img src="${rS.img}"><small>${rS.desc}</small></div>`;
            shop.style.display='block';
            saveBtn.style.display='block';
        }

        // TRAVEL
        window.generateTrip = function() {
            const dest = document.getElementById('tripDest').value;
            const days = parseInt(document.getElementById('tripDays').value);
            if(!dest || !days) return alert("Rellena destino y d√≠as");
            const pool = wardrobeData.filter(i => i.isDirty !== true);
            const tops = pool.filter(i=>i.cat==='top').sort(() => 0.5 - Math.random()).slice(0, days);
            const bottoms = pool.filter(i=>i.cat==='bottom').sort(() => 0.5 - Math.random()).slice(0, Math.ceil(days/2));
            const shoes = pool.filter(i=>i.cat==='shoes').sort(() => 0.5 - Math.random()).slice(0, 2);
            document.getElementById('tripTitle').innerText = `üß≥ Maleta para ${dest}`;
            const list = document.getElementById('tripList'); list.innerHTML = "";
            [...tops, ...bottoms, ...shoes].forEach(i => {
                list.innerHTML += `<div class="trip-item"><input type="checkbox" class="trip-check"><img src="${i.img}" style="width:50px; height:50px; object-fit:cover; border-radius:8px;"><div><b>${i.desc}</b><br><small>${i.cat}</small></div></div>`;
            });
            document.getElementById('tripResult').style.display = 'block';
        }

        // DARK MODE
        window.toggleTheme = function() { document.body.classList.toggle('dark-mode'); }

        // CALENDAR & OOTD
        let currentSimDay = 14;
        let recordedDays = [2, 4, 8, 12]; 
        let ootdHistory = {}; 
        window.saveOutfitToCalendar = function() {
            if(!currentGeneratedOutfit) return;
            ootdHistory[currentSimDay] = currentGeneratedOutfit;
            if(!recordedDays.includes(currentSimDay)) recordedDays.push(currentSimDay);
            alert(`‚úÖ Outfit guardado en el d√≠a ${currentSimDay}`);
            initCalendar();
        }
        window.simulateNextDay = function() {
            currentSimDay++; if(currentSimDay > 28) currentSimDay = 1; 
            document.getElementById('ootd-status').innerText = `Hoy es d√≠a ${currentSimDay}.`;
            initCalendar(); 
        }
        function initCalendar() {
            const grid = document.getElementById('ootdGrid'); grid.innerHTML = "";
            const days = ['L','M','X','J','V','S','D'];
            days.forEach(d => grid.innerHTML += `<div class="calendar-day" style="background:transparent;border:none;font-weight:bold;">${d}</div>`);
            for(let i=1; i<=28; i++) {
                const hasLook = recordedDays.includes(i);
                let dot = hasLook ? `<div class="dot"></div>` : '';
                let active = i === currentSimDay ? 'active' : '';
                let html = `<div class="calendar-day ${active}" onclick="clickDay(${i}, ${hasLook})">${i} ${dot}</div>`;
                grid.innerHTML += html;
            }
        }
        window.clickDay = function(day, hasLook) {
            if(hasLook) {
                document.getElementById('ootdDateTitle').innerText = `üìÖ D√≠a ${day}`;
                const content = document.getElementById('ootdContent'); content.innerHTML = "";
                if(ootdHistory[day]) {
                    const items = ootdHistory[day];
                    content.innerHTML = `<div class="ootd-gallery"><img src="${items[0].img}"><img src="${items[1].img}"><img src="${items[2].img}"></div><p style="margin-top:10px"><b>Look Guardado</b></p>`;
                } else if (wardrobeData.length > 0) {
                    const r = wardrobeData[Math.floor(Math.random()*wardrobeData.length)];
                    content.innerHTML = `<img src="${r.img}" class="ootd-preview-img"><p style="margin-top:10px">Look del historial</p>`;
                } else { content.innerHTML = "<p>Sin datos.</p>"; }
                document.getElementById('ootdModal').style.display = 'flex';
            } else if (day === currentSimDay) { alert("Ve a Outfits para guardar tu look."); }
        }
        window.closeOotdModal = function() { document.getElementById('ootdModal').style.display='none'; }

        // STATS & WEATHER
        function initWeather() {
            const w = [ { i: "‚òÄÔ∏è", t: "28¬∞C", d: "Soleado", tip: "Usa gafas" }, { i: "üåßÔ∏è", t: "14¬∞C", d: "Lluvia", tip: "Lleva paraguas" } ];
            const rand = w[Math.floor(Math.random()*w.length)];
            document.getElementById('weather-widget').innerHTML = `<div style="display:flex; gap:10px; align-items:center;"><span style="font-size:1.5rem">${rand.i}</span><div><b>Madrid</b><br>${rand.d} ¬∑ ${rand.t}</div></div><div style="text-align:right"><small>Tip IA:</small><br><b>${rand.tip}</b></div>`;
        }
        function updateStats() {
            document.getElementById('totalItems').innerText = wardrobeData.length;
            let totalVal = 0;
            wardrobeData.forEach(i => totalVal += parseFloat(i.price || 0));
            document.getElementById('totalValue').innerText = totalVal.toFixed(2) + '‚Ç¨';
            const total = wardrobeData.length;
            const dirty = wardrobeData.filter(i => i.isDirty === true).length;
            const percent = total > 0 ? Math.round((dirty / total) * 100) : 0;
            document.getElementById('laundry-count-txt').innerText = `${dirty} prendas necesitan lavado.`;
            document.getElementById('laundry-percent-txt').innerText = `Sucio (${percent}%)`;
            document.getElementById('laundry-fill-bar').style.width = `${percent}%`;
            if(wardrobeData.length > 0) {
                if(wardrobeData.length >= 3) document.getElementById('vintedCard').style.display = 'flex';
                const cpwList = document.getElementById('cpw-list'); cpwList.innerHTML = "";
                wardrobeData.slice(0, 3).forEach(i => {
                    const price = parseFloat(i.price) || 20; 
                    const uses = Math.floor(Math.random() * 20) + 1;
                    const cpw = (price / uses).toFixed(2);
                    cpwList.innerHTML += `<div class="shop-item" style="border:none; border-bottom:1px solid #eee; margin-bottom:0;"><div style="display:flex; align-items:center; gap:10px; width:100%;"><img src="${i.img}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;"><div><b>${i.desc}</b><br><small>${uses} usos</small></div><div style="margin-left:auto; text-align:right;"><b>${cpw}‚Ç¨</b><br><small>/uso</small></div></div></div>`;
                });
            }
        }

        window.nav = function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('nav-'+id).classList.add('active');
        }
    </script>
</body>
</html>
